<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #8b5cf6;
        }
        .stats {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .stat-item {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }
        .log {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-entry.error {
            color: #ff4444;
        }
        .log-entry.success {
            color: #44ff44;
        }
        .log-entry.info {
            color: #4444ff;
        }
        input[type="number"] {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 5px;
            width: 100px;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</h1>
    
    <div class="test-controls">
        <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞</h2>
        <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <input type="number" id="participantCount" value="1000" min="1" max="10000"></label>
        </div>
        <div style="margin-top: 10px;">
            <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (–º—Å): <input type="number" id="interval" value="10" min="1" max="1000"></label>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="startTest()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
            <button onclick="stopTest()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <button onclick="checkPerformance()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</button>
        </div>
    </div>
    
    <div class="stats" id="stats">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stat-item">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ: <span id="addedCount">0</span></div>
        <div class="stat-item">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <span id="elapsedTime">0</span> –º—Å</div>
        <div class="stat-item">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="speed">0</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤/—Å–µ–∫</div>
        <div class="stat-item">–†–∞–∑–º–µ—Ä localStorage: <span id="storageSize">0</span> KB</div>
        <div class="stat-item">–í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: <span id="saveTime">0</span> –º—Å (—Å—Ä–µ–¥–Ω–µ–µ)</div>
        <div class="stat-item">–û—à–∏–±–æ–∫: <span id="errorCount">0</span></div>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        let testRunning = false;
        let testInterval = null;
        let startTime = null;
        let addedCount = 0;
        let errorCount = 0;
        let saveTimes = [];
        
        // Simulate giveaway participants structure
        const testChannel = 'test_channel';
        const testGiveawayId = 'test_giveaway_' + Date.now();
        let testParticipants = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStats() {
            const elapsed = Date.now() - startTime;
            const speed = elapsed > 0 ? (addedCount / (elapsed / 1000)).toFixed(2) : 0;
            const avgSaveTime = saveTimes.length > 0 
                ? (saveTimes.reduce((a, b) => a + b, 0) / saveTimes.length).toFixed(2) 
                : 0;
            
            // Calculate localStorage size
            let storageSize = 0;
            try {
                const data = localStorage.getItem(`by_CTPAX_participants_${testChannel}`);
                if (data) {
                    storageSize = (new Blob([data]).size / 1024).toFixed(2);
                }
            } catch (e) {
                storageSize = 'N/A';
            }
            
            document.getElementById('addedCount').textContent = addedCount;
            document.getElementById('elapsedTime').textContent = elapsed;
            document.getElementById('speed').textContent = speed;
            document.getElementById('storageSize').textContent = storageSize;
            document.getElementById('saveTime').textContent = avgSaveTime;
            document.getElementById('errorCount').textContent = errorCount;
        }
        
        function simulateParticipant() {
            if (!testRunning) return;
            
            try {
                const username = `test_user_${addedCount + 1}`;
                const userId = `user_${addedCount + 1}`;
                
                // Add participant
                testParticipants.push({
                    username: username,
                    userId: userId
                });
                
                // Simulate save to localStorage
                const saveStart = performance.now();
                try {
                    const participantsData = {
                        [testGiveawayId]: testParticipants
                    };
                    localStorage.setItem(`by_CTPAX_participants_${testChannel}`, JSON.stringify(participantsData));
                    const saveTime = performance.now() - saveStart;
                    saveTimes.push(saveTime);
                    
                    // Keep only last 100 save times for average
                    if (saveTimes.length > 100) {
                        saveTimes.shift();
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        log(`‚ö†Ô∏è localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${addedCount} —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö!`, 'error');
                        errorCount++;
                        stopTest();
                        return;
                    } else {
                        throw e;
                    }
                }
                
                addedCount++;
                
                // Log every 100 participants
                if (addedCount % 100 === 0) {
                    log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`, 'success');
                }
                
                updateStats();
                
                // Check if we've reached the target
                const targetCount = parseInt(document.getElementById('participantCount').value);
                if (addedCount >= targetCount) {
                    log(`üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`, 'success');
                    stopTest();
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            }
        }
        
        function startTest() {
            if (testRunning) {
                log('–¢–µ—Å—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω', 'error');
                return;
            }
            
            // Reset
            testParticipants = [];
            addedCount = 0;
            errorCount = 0;
            saveTimes = [];
            startTime = Date.now();
            testRunning = true;
            
            log('üöÄ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏...', 'info');
            
            const interval = parseInt(document.getElementById('interval').value);
            testInterval = setInterval(simulateParticipant, interval);
        }
        
        function stopTest() {
            if (!testRunning) return;
            
            testRunning = false;
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            log('‚èπÔ∏è –¢–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
            updateStats();
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function checkPerformance() {
            log('üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...', 'info');
            
            // Check localStorage quota
            try {
                let testData = '';
                for (let i = 0; i < 1000; i++) {
                    testData += 'x';
                }
                localStorage.setItem('__test__', testData);
                localStorage.removeItem('__test__');
                
                // Estimate available space
                let used = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        used += new Blob([localStorage.getItem(key)]).size;
                    }
                }
                
                const available = (5 * 1024 * 1024) - used; // 5MB typical limit
                log(`üíæ –î–æ—Å—Ç—É–ø–Ω–æ –≤ localStorage: ${(available / 1024).toFixed(2)} KB`, 'info');
                log(`üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${(used / 1024).toFixed(2)} KB`, 'info');
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${e.message}`, 'error');
            }
            
            // Check current participants count
            try {
                const data = localStorage.getItem(`by_CTPAX_participants_${testChannel}`);
                if (data) {
                    const parsed = JSON.parse(data);
                    let total = 0;
                    Object.values(parsed).forEach(arr => {
                        if (Array.isArray(arr)) {
                            total += arr.length;
                        }
                    });
                    log(`üë• –¢–µ–∫—É—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ localStorage: ${total}`, 'info');
                }
            } catch (e) {
                log(`‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${e.message}`, 'info');
            }
        }
        
        // Auto-update stats
        setInterval(updateStats, 100);
    </script>
</body>
</html>

